<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Mastodon API Tester</title>
	<style>
		body {
			font-family: sans-serif;
		}
		.api-endpoint {
			cursor: pointer;
			font-weight: bold;
			color: blue;
			text-decoration: underline;
			margin-bottom: 10px;
		}
		summary {
			cursor: pointer;
			font-size: .9em;
		}
		#detailsblock, #api-endpoints {
			display: none;
		}
		details div {
			border-left: 3px solid #aaa;
			padding-left: 1em;
		}
		label {
			display: inline-block;
			width: 10em;
			line-height: 1.5em;
		}
		#save-request-log {
			display: none;
			font-size: .7em;
			font-weight: normal;
		}
		#request-log {
			margin-top: 20px;
			padding: 10px;
			border: 1px solid #ccc;
			background-color: #f9f9f9;
			border-radius: 4px;
		}
		#authorization-status::before {
			content: 'Authorization Status: ';
		}
		#authorization-status {
			border: 1px solid #aaa;
			border-radius: 3px;
			padding: 1em;
			margin: 1em 0;
			display: none;
		}
		img.hover {
			display: none;
			position: absolute;
		}
		a:hover img.hover {
			display: block;
		}
		tt.timestamp, tt.response-headers, tt.meta {
			color: #999;
		}
		tt#access-token-meta {
			margin-left: 1em;
			line-height: 1;
		}
		tt {
			white-space: pre;
			display: block;
			margin-bottom: 1em;
		}
		tt:last-child {
			margin-bottom: 0;
		}
		.header-key {
			font-weight: bold;
		}
		.header-value {
		}
		.path {
			color: #098658;
		}
		.number {
			color: #098658;
		}

		.string {
			color: #a31515;
		}

		.boolean {
			color: #0c9fc7;
		}

		.null {
			color: #bf6630;
		}

		.key {
			color: #000000;
			font-weight: bold;
		}

		.string-image {
			position: relative;
		}

	</style>
</head>

<body>
	<h1>Mastodon API Tester</h1>
	<div id="client-data">
		<label for="base-url">Mastodon Instance:</label>
		<input type="url" size="50" id="base-url" value="" required/><br/>

		<label for="client-name">Test Client Name:</label>
		<input type="text" size="50" id="client-name" value="Mastodon API Tester" required/>
		<br/>
	</div>
	<div id="authorization-status"></div>
	<button id="authorize">Authorize</button>

	<details id="detailsblock"><summary>Authorization Data</summary>
		<div id="authorizaton-data">
			<label for="redirect-uri">Redirect URI:</label>
			<input type="text" size="50" id="redirect-uri">
			<br/>

			<label for="client-id">Client ID:</label>
			<input type="text" size="50" id="client-id">
			<br/>

			<label for="client-secret">Client Secret:</label>
			<input type="text" size="50" id="client-secret">
			<button id="get-access-token">Get New Access Token</button>
			<br/>

			<label for="access-token">Access Token:</label>
			<input type="text" size="50" id="access-token">
			<tt id="access-token-meta"></tt>
			<br/>

			<input type="reset" id="reset"> <input type="reset" id="delete-local" value="Delete Local Storage Data">
		</div>
	</details>

	<div id="api-endpoints">
		<h2>API Endpoints</h2>
		<div class="api-endpoint">/api/v1/accounts/verify_credentials</div>
		<div class="api-endpoint">/api/v1/timelines/home</div>
	</div>
	<h2>Request Log <a href="data:" id="save-request-log">Save</a></h2>
	<div id="request-log"></div>

	<script>
		function logRequest( data ) {
			const div = document.createElement('div');
			const timestamp = document.createElement('tt');
			timestamp.className = 'timestamp';
			timestamp.textContent = '-- Request at ' + new Date().toISOString();
			div.appendChild( timestamp );
			const request = document.createElement('tt');
			request.className = 'request';
			div.appendChild( request );
			const meta = document.createElement('tt');
			meta.className = 'meta';
			div.appendChild( meta );
			const responseHeaders = document.createElement('tt');
			responseHeaders.className = 'response-headers';
			div.appendChild( responseHeaders );
			const responseEl = document.createElement('tt');
			responseEl.className = 'response';
			div.appendChild( responseEl );
			let html = '<span class="method">' + htmlescape( data.method || 'GET' ) + '</span> <span class="path">' + htmlescape( data.endpoint ) + '</span><br/>';
			html += '<span class="header-key">Server</span>: <span class="header-value">' + htmlescape( data.baseURL ) + '</span><br/>';
			if ( data.accessToken ) {
				html += '<span class="header-key">Authorization</span>: <span class="header-value">Bearer ' + htmlescape( data.accessToken ) + '</span><br/>'
			};
			html += '<span class="header-key">Content-Type</span>: <span class="header-value">application/json</span><br/>';
			html += '<span class="header-key">Accept</span>: <span class="header-value">application/json</span>';
			if ( data.body ) {
				html += '<br/><tt>' + jsonSyntaxHighlight( data.body )
			};
			request.innerHTML = html;
			const requestLog = document.getElementById('request-log');
			if ( requestLog.childNodes.length ) {
				requestLog.insertBefore( div, requestLog.childNodes[0] );
			} else {
				requestLog.appendChild( div );
			}

			const errorReceived = function ( data ) {
				clearInterval( intervalId );
				const currentTime = new Date().getTime();
				const seconds = ((currentTime - startTime) / 1000 ).toFixed( 1 );
				meta.textContent = `!! Response received after ${seconds} seconds`;

				responseEl.textContent = data;
				updateSaveLink();
				return data;
			}

			const responseReceived = function ( data ) {
				clearInterval( intervalId );
				const currentTime = new Date().getTime();
				const seconds = ((currentTime - startTime) / 1000 ).toFixed( 1 );
				meta.textContent = `-- Response received after ${seconds} seconds`;

				responseEl.innerHTML = jsonSyntaxHighlight( data );
				updateSaveLink();
				return data;
			}

			const startTime = new Date().getTime();

			const intervalId = setInterval(() => {
				const currentTime = new Date().getTime();
				const seconds = ((currentTime - startTime) / 1000 ).toFixed( 1 );
				meta.textContent = `-- Waiting for response (${seconds} seconds)`;
			}, 100);

			const receivedHeaders = function ( response ) {
				if ( typeof response === 'string' ) {
					throw new Error( response );
				}
				let headers = 'HTTP Status: ' + response.status + "\n";
				for (const [name, value] of response.headers) {
					headers += '<span class="header-key">' + htmlescape( name ) + '</span>: ';
					headers += '<span class="header-value">' + htmlescape( value ) + '</span><br/>';
				}
				responseHeaders.innerHTML = headers;
				if ( ! response.ok ) {
					return response.json();
				}
				return response.json();
			}

			const updateSaveLink = function() {
				const a = document.getElementById('save-request-log');
				const currentDate = new Date();
				a.setAttribute('download', 'mastodon-api-tester-log_' + currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1) + '-' + currentDate.getDate() + '_' + currentDate.getHours() + '-' + currentDate.getMinutes() + '-' + currentDate.getSeconds() + '.txt' );
				a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(requestLog.innerText);
				a.style.display = 'inline';
			};

			return { receivedHeaders, responseReceived, errorReceived };
		}
		function createApp(url, client_name) {
			const baseURL = url.replace(/\/+$/, '');
			const method = 'POST';
			const body = {
				client_name,
				redirect_uris: window.location.href,
				scopes: 'read write follow'
			};
			localStorage.setItem('baseURL', baseURL);
			localStorage.setItem('redirectURI', window.location.href);
			document.getElementById('redirect-uri').value = window.location.href;
			const endpoint = '/api/v1/apps';
			const log = logRequest( {baseURL, endpoint, method, body })
			fetch(`${baseURL}${endpoint}`, {
				method,
				headers: {
					'Content-Type': 'application/json',
					'Accept': 'application/json'
				},
				body: JSON.stringify( body )
			})
			.catch(log.errorReceived)
			.then(log.receivedHeaders)
			.then(log.responseReceived)
			.then(data => {
				if ( ! data ) {
					return;
				}
				localStorage.setItem('clientID', data.client_id);
				document.getElementById('client-id').value = data.client_id;
				localStorage.setItem('clientSecret', data.client_secret);
				document.getElementById('client-secret').value = data.client_secret;
				authorizeUser(baseURL, data.client_id);
			})
			.catch(log.errorReceived);
		}

		function isAuthorized() {
			document.getElementById('detailsblock').insertBefore( document.getElementById('client-data'), document.getElementById('authorizaton-data') );
			document.getElementById('api-endpoints').style.display = 'block';
			document.getElementById('authorization-status').style.display = 'block';
			document.getElementById('detailsblock').style.display = 'block';
			document.getElementById('authorization-status').textContent = 'Authorized.';
			document.getElementById('authorize').textContent = 'Re-Authorize';
		}

		function authorizeUser(baseURL, clientID) {
			const redirectURI = encodeURIComponent(localStorage.getItem('redirectURI') );
			const authURL = `${baseURL}/oauth/authorize?client_id=${clientID}&redirect_uri=${redirectURI}&response_type=code&scope=read%20write`;
			window.location.href = authURL;
		}

		function getAccessToken(baseURL, clientID, clientSecret, code) {
			const method = 'POST';
			const endpoint = '/oauth/token';
			const body = {
				client_id: clientID,
				client_secret: clientSecret,
				redirect_uri: localStorage.getItem('redirectURI'),
				code: code,
				grant_type: 'authorization_code'
			};
			const log = logRequest( { method, baseURL, endpoint, body } );
			fetch(`${baseURL}${endpoint}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Accept': 'application/json'
				},
				body: JSON.stringify( body )
			})
			.then(log.receivedHeaders)
			.then(log.responseReceived)
			.then(data => {
				const urlParams = new URLSearchParams(window.location.search);
				urlParams.delete('code');
				history.replaceState(null, null, `${window.location.pathname}?${urlParams.toString()}`);

				if ( ! data.access_token ) {
					console.error('Error getting access token:', data);
					return;
				}
				let currentTime = new Date();
				currentTime.setSeconds(currentTime.getSeconds() + data.expires_in);
				data.expires_at = currentTime.toLocaleString();
				currentTime = new Date( data.created_at * 1000 );
				data.created_at = currentTime.toLocaleString();

				localStorage.setItem('accessTokenMeta', JSON.stringify( data, null, "\n" ) );
				localStorage.setItem('accessToken', data.access_token);
				document.getElementById('access-token').value = data.access_token;
				document.getElementById('access-token-meta').innerHTML = jsonSyntaxHighlight( localStorage.getItem('accessTokenMeta') );
				isAuthorized();

			})
			.catch(log.errorReceived);
		}

		document.getElementById('base-url').addEventListener('keypress', function( event ) {
			if (event.keyCode === 13) {
				document.getElementById('authorize').click();
			}
		} );
		document.getElementById('client-name').addEventListener('keypress', function( event ) {
			if (event.keyCode === 13) {
				document.getElementById('authorize').click();
			}
		} );
		document.getElementById('authorize').addEventListener('click', function() {
			const baseURL = document.getElementById('base-url');
			if ( ! baseURL.checkValidity() ) {
				baseURL.reportValidity();
				return;
			}
			const clientName = document.getElementById('client-name');
			if ( ! clientName.checkValidity() ) {
				clientName.reportValidity();
				return;
			}
			const clientID = document.getElementById('client-id').value;
			if ( ! clientID ) {
				return createApp( baseURL.value, clientName.value );
			}

			return authorizeUser(baseURL, clientID);
		});

		document.getElementById('get-access-token').addEventListener('click', function() {
			const baseURL = document.getElementById('base-url').value;
			const clientID = document.getElementById('client-id').value;
			authorizeUser(baseURL, clientID);
		});

		document.getElementById('delete-local').addEventListener('click', function() {
			localStorage.clear();
			location.reload();
		});


		document.getElementById('reset').addEventListener('click', function() {
			document.getElementById('client-data').style.display = 'block';
			document.getElementById('client-id').value = '';
			document.getElementById('client-secret').value = '';
			document.getElementById('access-token').value = '';
			document.getElementById('access-token-meta').textContent = '';
		});

		document.addEventListener('DOMContentLoaded', function() {
			const timestamp = document.createElement('tt');
			timestamp.className = 'timestamp';
			timestamp.textContent = '-- Page loaded at ' + new Date().toISOString();
			document.getElementById('request-log').appendChild( timestamp );

			const baseURL = localStorage.getItem('baseURL');
			const redirectURI = localStorage.getItem('redirectURI');
			const clientID = localStorage.getItem('clientID');
			const clientSecret = localStorage.getItem('clientSecret');
			const accessToken = localStorage.getItem('accessToken');
			document.getElementById('base-url').value = baseURL;
			document.getElementById('redirect-uri').value = redirectURI;
			document.getElementById('client-id').value = clientID;
			document.getElementById('client-secret').value = clientSecret;
			document.getElementById('access-token').value = accessToken;
			document.getElementById('access-token-meta').innerHTML = jsonSyntaxHighlight( localStorage.getItem('accessTokenMeta') );
			if ( baseURL && clientID && clientSecret ) {
				const urlParams = new URLSearchParams( window.location.search );
				if ( urlParams.get('code') ) {
					return getAccessToken( baseURL, clientID, clientSecret, urlParams.get('code') );
				}
			}

			if ( accessToken ) {
				isAuthorized();
				return;
			}

		});
		function htmlescape( text ) {
			return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		}


		document.addEventListener("mouseover", (event) => {
			if (event.target.classList.contains('display-image')) {
				const link = event.target;

				const img = document.createElement("img");
				img.className = 'hover'
				img.src = link.href;

				link.appendChild(img);
			}
		});

		function jsonSyntaxHighlight(json) {
			if (typeof json !== 'string') {
				json = JSON.stringify(json, undefined, 2);
			}

			let displayImage = '';
			return htmlescape( json ).replace(
				/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(\.\d+)?([eE][+-]?\d+)?)/g,
				function (match) {
					let cls = 'number';
					if (/^"/.test(match)) {
						if (/:$/.test(match)) {
							cls = 'key';
							displayImage = /^"(avatar|header)(_static)?":$/.test( match ) ? ' display-image' : '';
						} else {
							cls = 'string';
							if (/^"(https?:\/\/[^"]+)"$/.test(match)) {
								return `<a href="${match.slice(1, -1)}" class="url${displayImage}" target="_blank">${match}</a>`;
							}
						}
					} else if (/true|false/.test(match)) {
						cls = 'boolean';
					} else if (/null/.test(match)) {
						cls = 'null';
					}
					return '<span class="' + cls + '">' + match + '</span>';
				}
				);
		}

		document.addEventListener('click', function(event) {
			if (event.target.classList.contains('api-endpoint')) {
				const baseURL = document.getElementById('base-url').value.replace(/\/+$/, '');
				const endpoint = event.target.dataset.endpoint || event.target.textContent;
				const method = event.target.dataset.method || 'GET';
				const accessToken = localStorage.getItem('accessToken');
				const requestURL = `${baseURL}${endpoint}`;

				const log = logRequest( { method, endpoint, baseURL, accessToken } );
				fetch(
					requestURL, {
						method: method,
						headers: {
							'Authorization': `Bearer ${accessToken}`,
							'Content-Type': 'application/json',
							'Accept': 'application/json'
						}
					}
					)
				.then(log.receivedHeaders)
				.then(log.responseReceived)
				.catch(log.errorReceived);
			}
		});
	</script>
</body>

</html>
